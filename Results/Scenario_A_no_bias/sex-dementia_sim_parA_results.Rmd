---
title: "Simulation Scenario A:  No bias anticipated"
output: 
  bookdown::html_document2:
    theme: flatly
    toc: TRUE
    toc_float: 
      collapsed: FALSE
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r Pacman statement}
if (!require("pacman")) 
  install.packages("pacman", repos='http://cran.us.r-project.org')

p_load("bookdown", "here", "tidyverse", "knitr", "kableExtra", "magrittr", 
       "reshape2", "survival")

options(digits = 3)
options(scipen = 999)
```

```{r Seed setting}
set.seed(03122019)
```

```{r Sourcing scripts}
source(here("RScripts", "dementia_incidence_EURODEM_pooled.R"))
source(here("RScripts", "sex-dementia_sim_parA.R"))
source(here("RScripts", "variable_names.R"))
source(here("RScripts", "misc_custom_functions.R"))
```

```{r Loading data, eval = TRUE}
#Life table data
netherlands_MF <- read_csv(here("Data", "Netherlands_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
netherlands_M <- read_csv(here("Data", "Netherlands_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
netherlands_F <- read_csv(here("Data", "Netherlands_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_MF <- read_csv(here("Data", "denmark_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_M <- read_csv(here("Data", "denmark_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_F <- read_csv(here("Data", "denmark_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_MF <- read_csv(here("Data", "france_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_M <- read_csv(here("Data", "france_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_F <- read_csv(here("Data", "france_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)

#One simulation run
test_data <- readRDS(here("Data", "test_sim_results_A_20190312"))

#Data Analyses
sim_results <- read_csv(here("Results", "Scenario_A_no_bias", 
                             "sim_results_20190312.csv"))
```

<br>
<br>

```{r DAG, fig.align="center", out.width="75%"}
knitr::include_graphics(here("DAGs", "sex-dem_sim_parA_DAG.png"))
```
<br>

In this scenario, sex influences survival while U influences the rate of cognitive change and dementia incidence.  The dotted line from U to survival represents the fact that in this causal structure, U does not influence survival; but the effects of U on survival will be added in future scenarios to induce potential collider bias.

<br>

#  Description of Hypothetical Cohort Study 
This is a hypothetical cohort study of sex/gender differences in dementia incidence.  The hypothetical cohort included 100,000 men and women recruited at age 50 years and followed for dementia incidence until age 95 (45 years).  To quantify the extent to which selective survival could plausibly explain higher dementia incidence in men than women at older ages, we generated the data assuming no effect of sex/gender on late-life cognitive trajectories and dementia incidence. Thus, associations between sex/gender and dementia incidence reflect survival bias in our simulations.  

## Survival 

Sex-specific survival distributions from ages 50-95 years were generated to match survival distributions from European Life Tables. We found European cohort life tables on UC Berkeley's repository:  [https://www.mortality.org/](https://www.mortality.org/).  For those countries included in the EURODEM study, Figure 1.1 shows mortality hazard ratios plotted for the 1920-1925 birth cohort.  

**Figure 2.1:  Published Survival Hazard Ratios for Countries in the EURODEM Study**

```{r HR Plots, fig.align="center"}
Hratio_Netherlands <- netherlands_F$Haz/netherlands_M$Haz %>%
  as.data.frame() %>% set_colnames("Netherlands") 
Hratio_Denmark <- denmark_F$Haz/denmark_M$Haz %>%
  as.data.frame() %>% set_colnames("Denmark") 
Hratio_France <- france_F$Haz/france_M$Haz %>%
  as.data.frame() %>% set_colnames("France") 

HR_plot_data <- 
  cbind(Hratio_Netherlands, Hratio_Denmark, Hratio_France) %>% 
  mutate("Age" = seq(50, 95, by = 5)) %>%
  gather(c("Netherlands", "Denmark", "France"), 
         key = "Country", value = "HR") %>% 
  mutate_at("Country", as.factor)
HR_plot_data$Country <- fct_relevel(HR_plot_data$Country, 
                                    "France", after = 2)

ggplot(HR_plot_data, aes(Age, HR)) + 
  geom_line(aes(color = Country, group = Country), size = 1.25, alpha = 0.6) +
  labs(y = "Mortality Hazard Ratio (Female:Male)", x = "Age", 
       color = "") + ylim(0, 1) + theme_minimal() + 
  scale_y_continuous(breaks = seq(0, 1, 0.2)) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("1920-1925 Birth Cohort")
```

Since the Netherlands cohort was the largest sample included in the EURODEM study and because their mortality hazard ratios provided a nice middle ground in the 50+ age group, we decided to use Netherlands life tables as our benchmark.  

Using R's optim function, we were able to solve for the $\lambda$ values (baseline hazard for women) in our survival model so that conditional probabilities of survival in our simulated data closely matched those calculated from the Netherlands life tables.  Table 2.1 shows the computed values of $\lambda$ and Figure 1.2 

<br>

**Table 1.1:  Lambda Values**

```{r Lambda values}
lambda_values <- lambda %>% t() %>% as.data.frame() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("Lambda")

kable(lambda_values) 
```

<br>

**Figure 1.2: Average Simulated Cumulative Survival Probabilites from Age 50 Years across 100 Simulation Runs**

```{r Survival plot data}
all_cp_survival <- c(1, sim_results$p_alive)
female_cp_survival <- c(1, sim_results$p_alive_females)
male_cp_survival <- c(1, sim_results$p_alive_males)

#Netherlands data that we need
netherlands_MF_survival <- netherlands_MF %>% filter(Age >= 50)
netherlands_M_survival <- netherlands_M %>% filter(Age >= 50)
netherlands_F_survival <- netherlands_F %>% filter(Age >= 50)

#Calculating cumulative survival from age 50
netherlands_MF_survival$CP <- 
  netherlands_MF_survival$lx/netherlands_MF_survival$lx[1]
netherlands_M_survival$CP <- 
  netherlands_M_survival$lx/netherlands_M_survival$lx[1]
netherlands_F_survival$CP <- 
  netherlands_F_survival$lx/netherlands_F_survival$lx[1]

plot_data <- tibble("age" = seq(50, 95, by = 5), 
                      "pub_all_survival" = netherlands_MF_survival$CP, 
                      "pub_female_survival" = netherlands_F_survival$CP, 
                      "pub_male_survival" = netherlands_M_survival$CP, 
                      "cohort_all_survival" = all_cp_survival, 
                      "cohort_female_survival" = female_cp_survival, 
                      "cohort_male_survival" = male_cp_survival) 
```

```{r All survival plots, fig.align="center", out.width="60%"}
#All survival plot
plot_data_all <- plot_data %>% dplyr::select(age, contains("all")) %>%
  gather(key = key, value = value, 
         c("pub_all_survival", "cohort_all_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_all_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_all, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  labs(title = "Whole Population", 
       y = "Conditional Probability of Survival", 
       x = "Age") + 
  theme_minimal()
```

```{r Survival Plots by sex, fig.pos="hold", out.width="50%"}
#Female survival plot
plot_data_female <- plot_data %>% dplyr::select(age, contains("female")) %>%
  gather(key = key, value = value, 
         c("pub_female_survival", "cohort_female_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_female_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_female, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  labs(title = "Females", 
       y = "Conditional Probability of Survival", 
       x = "Age") + 
  theme_minimal()

#Male survival plot
plot_data_Male <- plot_data %>% dplyr::select(age, contains("Male")) %>%
  gather(key = key, value = value, 
         c("pub_male_survival", "cohort_male_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_male_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_Male, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  labs(title = "Males", 
       y = "Conditional Probability of Survival", 
       x = "Age") + 
  theme_minimal()
```

<br>

**Figure 2.3: Survival Hazard Ratios**  
Ages on the x-axis represent the age at the start of interval, i.e. 50 represents the HR for the interval [50, 55).

```{r Cox PH}
survival_data <- test_data %>% 
  dplyr::select(head(variable_names$Sij_varnames, -1))
survival_data[(survival_data >= 5)] <- 4.99999

death_indicators_sex <- test_data %>% 
  dplyr::select(head(variable_names$deathij_varnames, -1), female)

simulated_HRs <- vector(length = ncol(survival_data)) %>%
  as.data.frame() %>% set_colnames("Modeled HR")

for(i in 1:nrow(simulated_HRs)){
  cox_model <- coxph(Surv(survival_data[, i], death_indicators_sex[, i]) ~ 
                      death_indicators_sex$female)
  simulated_HRs[i, 1] <- exp(cox_model$coefficients)
}

```

```{r pub vs. sim HR, fig.pos="hold"}
published_HR <- netherlands_F$Haz/netherlands_M$Haz
published_HR <- published_HR[11:(length(published_HR) - 1)] %>%
  as.data.frame() %>% set_colnames("Published HR")

pub_sim_HR_data_cox <- 
  cbind(published_HR, simulated_HRs) %>% 
  mutate("Age" = seq(50, 90, by = 5)) %>%
  gather(c("Published HR", "Modeled HR"), 
         key = "Data Type", value = "HR") %>% 
  mutate_at("Data Type", as.factor)
pub_sim_HR_data_cox$`Data Type` <- fct_relevel(pub_sim_HR_data_cox$`Data Type`, 
                                               "Published HR", after = 1)

ggplot(pub_sim_HR_data_cox, aes(Age, HR)) + 
  geom_line(aes(color = `Data Type`, group = `Data Type`), size = 1.25, 
            alpha = 0.6) +
  labs(y = "Hazard Ratio (Female:Memale)", x = "Age", 
       color = "") + theme_minimal() + 
  ggtitle("Simulated vs. Published HRs")
```
 

The results in this summary are based on `r runs` simulated cohorts of on average n = `r formatC(na.omit(sim_results$num_obs[1]), format = "d", big.mark = ",")` 50 year old individuals who were followed for up to 45 years with assessments for dementia status every five years. Average cumulative incidence of mortality  = `r round((1 - sim_results$p_alive[length(sim_results$p_alive)])*100, 1)`%. 

In this summary, we consider the scenario in which sex had no effect on development of dementia, but female sex decreased mortality risk. Results in this simulation that reject the null hypothesis that sex has no effect on dementia incidence (HR = 1.00) are wrong.

# Simulation Results

##  Survival


## Dementia

Average dementia incidence rates per 1000 person years across the simulated cohorts are displayed in Table 2.2.  There is no interval censoring for dementia in the simulated scenarios.  The dementia incidence rates from the EURODEM study, used as reference, are displayed in the first line of the table.  

The average hazard ratios for dementia across our simulated scenarios are displayed in Table 2.3, and the average incidence rate ratios are displayed in Table 2.4.  In both cases, ratios are presented as female:male.

<br>

**Table 2.2: Dementia Incidence Rates**  
Source: Gender differences in the incidence of AD and vascular dementia: 
The EURODEM Studies (Andersen 1999); Table 2

```{r dem_table}
age_labels <- tibble("age" = c("age ", rep("", (num_tests - 1))), 
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", sep = "")

dem_table <- 
  tibble("EURODEM" = c(" ", " ", " ", 
                       round(head(EURODEM_inc_rates$Total_All_Dementia_1000PY, 
                                  -1), 3)), 
         "Scenario A" = " ", 
         "F" = sim_results$sim_rates_females, 
         "M" = sim_results$sim_rates_males, 
         "Combined" = sim_results$sim_rates) %>% t() %>% 
  set_colnames(age_labels$formatted_age_intervals)

kable(dem_table)
```

<br>

**Table 2.3: Hazard Ratios for Dementia**  

```{r hr_table}
age_labels <- tibble("age" = c("age ", rep("", (num_tests - 1))), 
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", sep = "")

hr_table <- 
  tibble("Scenario A" = " ", 
         "HR" = sim_results$`dem_HRs(F:M)`) %>% t() %>% 
  set_colnames(age_labels$formatted_age_intervals)

kable(hr_table)
```

<br>

**Table 2.4: Incidence Rate Ratios for Dementia**  

```{r IRR_table}
age_labels <- tibble("age" = c("age ", rep("", (num_tests - 1))), 
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", sep = "")

IRR_table <- 
  tibble("Scenario A" = " ", 
         "IRR" = sim_results$`IRRs(F:M)`) %>% t() %>% 
  set_colnames(age_labels$formatted_age_intervals)

kable(IRR_table)
```


# Some results from one simulated cohort

##  Cognitive Trajectories

**Figure 3.1:  Mean cognitive trajectories overlayed on a random sample of 10 individual's trajectories.**

```{r Cognitive trajectories, fig.align="center"}
Cij_check <- test_data %>% dplyr::select(sex, variable_names$Cij_varnames)

#Getting mean Cij by sex
female_meanCij<- Cij_check %>% filter(sex == 0) %>% colMeans(., na.rm = TRUE)
male_mean_Cij <- Cij_check %>% filter(sex == 1) %>% colMeans(., na.rm = TRUE)

#Checking the mean slopes by sex
slopes_check <- test_data %>% dplyr::select(sex, contains("slope"))
female_slopes_check <- slopes_check %>% filter(sex == 0) %>% colMeans()
male_slopes_check <- slopes_check %>% filter(sex == 1) %>% colMeans()

female_mean_plot <- tibble("Age" = seq(50, 95, by = 5), "variable" = "female", 
                           "value" = female_meanCij[-1])

male_mean_plot <- tibble("Age" = seq(50, 95, by = 5), "variable" = "male", 
                         "value" = male_mean_Cij[-1])


#Create all plot data (includes random sample of Cij)
samp_Cij <- sample_n(Cij_check, 10) %>% 
  dplyr::select(-sex) %>% t() %>%
  cbind(., "Age" = seq(50, 95, by = 5)) %>% as.data.frame() %>% 
  melt(., id.vars = "Age") %>% rbind(., female_mean_plot) %>% 
  rbind(., male_mean_plot)

#---- Plot a sample of Cij ----
#Creating a plot with random sample in the background
ggplot(samp_Cij, aes(Age, value)) + 
  geom_line(data = 
              subset(samp_Cij, variable != "female" & variable != "male"), 
            aes(group = variable), color = "gray") +
  geom_line(data = subset(samp_Cij, variable == "female"), 
            aes(color = variable), size = 1.25) + 
  geom_line(data = subset(samp_Cij, variable == "male"), 
            aes(color = variable), size = 1.25, alpha = 0.6) + 
  labs(y = "Cognitive Function", 
       x = "Age", 
       color = "Mean Cognitive \n Function") + 
  ggtitle("Mean Cognitive Trajectories") +
  theme_minimal()
```

<br>

**Table 3.1: Mean slopes at each interval** 

```{r Slopes table}
slopes <- cumsum(cij_slopes)[-1] %>% as.data.frame() %>% t() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("")

kable(slopes)
```

<br>

**Table 3.2:  Variance of random slope for each interval**  

```{r slope variance table}
slope_var <- cij_var1[-1] %>% as.data.frame() %>% t() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("")

kable(slope_var)
```

## Dementia Cases

**Figure 3.2:  Dementia cases by age**  
Incident cases at each age are plotted in blue

```{r Dementia incidence rate plot, fig.align="center"}
cutoffs <- dem_cuts
Cij_data <- test_data %>% dplyr::select(variable_names$Cij_varnames)
dem_wave_data <- test_data %>% dplyr::select(dem_wave)
Cij_indicators <- matrix(0, nrow = nrow(Cij_data), ncol = ncol(Cij_data))
for(i in 1:nrow(dem_wave_data)){
  if(!is.na(dem_wave_data[i, ])){
    slot <- dem_wave_data[i, ]
    Cij_indicators[i, (slot + 1)] <- 1
  }
}
indicators <- unlist(as.data.frame(Cij_indicators))

#Colnames for hist data
age_names <- tibble("Age" = rep("Age", 10), 
                    "number" = seq(50, 95, by = 5)) %>%
  unite("age_names", sep = " ")

hists <- Cij_data %>% set_colnames(age_names$age_names) %>% gather() %>% 
  mutate_at("key", as.factor) 
hists$indicators <- indicators

z <- data.frame(key = levels(hists$key), 
                cutoff = cutoffs)
  
hists %>% ggplot(aes(value)) + 
  geom_vline(data = z, aes(xintercept = cutoff), color = "black", size = 1) + 
  geom_histogram(fill = "gray", alpha = 0.6) + 
  geom_histogram(data = hists %>% filter(indicators == 1), fill = "dodgerblue2", 
                 alpha = 0.6) + 
  labs(title = "Dementia Cases by Age", 
       x = "Cognitive Level", 
       y = "Live People") + 
  facet_wrap(~ key, scales = "free") + 
  xlim(-30, 3.5) + theme_minimal()
```

<br>

**Table 3.3:  Dementia cut points and associated percentiles**  
The percentile is the proportion of susceptible that will be diagnosed with dementia

```{r cutoffs and percentiles}
means <- Cij_data %>% map_dbl(~ mean(., na.rm = TRUE))
SDs <- Cij_data %>% map_dbl(~ sd(., na.rm = TRUE))

percentile <- vector(length = length(dem_cuts))
for(i in 1:length(dem_cuts)){
  percentile[i] <- pnorm(dem_cuts[i], mean = means[i], sd = SDs[i])
}

percentile_table <- rbind(dem_cuts, percentile)
colnames(percentile_table) <- age_names$age_names
rownames(percentile_table) <- c("Dementia Cutoff", "Percentile")
kable(percentile_table)
```

<br>

**Table 3.4:  Prevalence of dementia**  
Estimating this is not our primary goal, but we thought this might be another good sanity check.  We expect that these numbers are higher than what they should be because in this scenario, dementia does not kill anyone. 

```{r Dementia prevalance}
dem_prev <- test_data %>% dplyr::select(variable_names$dem_varnames) %>% 
  colMeans(na.rm = TRUE) %>% as.data.frame() %>% t() %>%
  set_colnames(age_names$age_names) %>% set_rownames("Prevalence")

kable(dem_prev)
```

## Distributions of U

**Figure 3.3:  Distribution of U**

```{r U dists, fig.align="center"}
dem_data <- test_data %>% 
  dplyr::select(c("sex", "U", "death0", 
                  head(variable_names$deathij_varnames, -1))) %>%
  mutate("Sex" = if_else(sex == 1, "Male", "Female")) %>% 
  dplyr::select(-one_of("sex")) %>% 
  dplyr::select("U", "death0", everything()) %>% 
  set_colnames(c("U", age_names$age_names, "Sex")) %>%
  gather(contains("Age"), 
         key = "Age", value = "death_indicator") %>%
  filter(death_indicator == 0)

dem_data %>% ggplot(aes(x = U)) + 
  geom_histogram(data = dem_data %>% filter(Sex == "Female"), 
                 aes(y = ..density.., fill = "Female"),
                 binwidth = 0.01) +
  geom_histogram(data = dem_data %>% filter(Sex == "Male"), 
                 aes(y = ..density.., fill = "Male"), alpha = 0.5,
                 binwidth = 0.01) + 
  xlim(-5, 5) + ylim(0, 0.6) + 
  labs(title = "Distribution of U by Age", 
       x = "U", 
       y = "Density") + 
  facet_wrap(~ Age, scales = "free") + theme_minimal() + 
  theme(legend.title = element_text("Sex"))
```

# Extra Sanity Check Calculations

**Table 4.1:  Contributed years by sex**

```{r PY by sex}
py_by_sex <- test_data %>% group_by(sex) %>% 
  dplyr::select(head(variable_names$contributed_varnames, -1)) %>% 
  summarise_all(~sum(., na.rm = TRUE)) %>% 
  mutate(Sex = case_when(sex == 0 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(-one_of("sex")) %>% 
  dplyr::select(Sex, everything())

kable(py_by_sex)
```

<br>

**Table 4.2:  Incident Dementia Cases by Sex**

```{r Dem inc}
dem_inc_by_sex <- test_data %>%
  dplyr::select(sex, dem_wave) %>% 
  mutate_at("dem_wave", as.factor) %>% 
  mutate(Sex = case_when(sex == 0 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(Sex, dem_wave) %>% 
  group_by(Sex) %>%
  count(dem_wave) %>% 
  filter(dem_wave != "NA") %>% spread(key = Sex, value = n) %>% t() %>%
  set_rownames(c("Sex", "Female", "Male")) %>% 
  set_colnames(variable_names$dem_varnames[-c(1)])
  
kable(dem_inc_by_sex[-1, ])
```




