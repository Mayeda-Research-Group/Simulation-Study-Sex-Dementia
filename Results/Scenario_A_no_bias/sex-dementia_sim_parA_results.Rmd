---
title: "Simulation Scenario A:  No bias anticipated"
output: 
  bookdown::html_document2:
    theme: flatly
    toc: TRUE
    toc_float: 
      collapsed: FALSE
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r Pacman statement}
if (!require("pacman")) 
  install.packages("pacman", repos='http://cran.us.r-project.org')

p_load("bookdown", "here", "tidyverse", "knitr", "kableExtra", "magrittr", 
       "reshape2", "survival")

options(digits = 3)
options(scipen = 999)
```

```{r Seed setting}
set.seed(03122019)
```

```{r Sourcing scripts}
source(here("RScripts", "dementia_incidence_EURODEM_pooled.R"))
source(here("RScripts", "sex-dementia_sim_parA.R"))
source(here("RScripts", "variable_names.R"))
source(here("RScripts", "misc_custom_functions.R"))
```

```{r Loading data, eval = TRUE}
#Life table data
netherlands_MF <- read_csv(here("Data", "Netherlands_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
netherlands_M <- read_csv(here("Data", "Netherlands_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
netherlands_F <- read_csv(here("Data", "Netherlands_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_MF <- read_csv(here("Data", "denmark_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_M <- read_csv(here("Data", "denmark_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_F <- read_csv(here("Data", "denmark_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_MF <- read_csv(here("Data", "france_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_M <- read_csv(here("Data", "france_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_F <- read_csv(here("Data", "france_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)

#One simulation run
test_data <- readRDS(here("Data", "test_sim_results_A_20190312"))

#Data Analyses
sim_results <- read_csv(here("Results", "Scenario_A_no_bias", 
                             "sim_results_20190312.csv"))
```

```{r Column names}
#Interval labels i.e. [50, 55)
age_labels <- tibble("age" = c("age ", rep("", (num_tests - 1))), 
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", sep = "")

#Age and #, i.e. Age 50
age_names <- tibble("Age" = c("Age ", rep("", 9)), 
                    "number" = seq(50, 95, by = 5)) %>%
  unite("age_names", sep = "")
```

<br>
<br>

```{r DAG, fig.align="center", out.width="75%"}
knitr::include_graphics(here("DAGs", "sex-dem_sim_parA_DAG.png"))
```
<br>

In this scenario, sex influences survival while U influences the rate of cognitive change and dementia incidence.  The dotted line from U to survival represents the fact that in this causal structure, U does not influence survival; but the effects of U on survival will be added in future scenarios to induce potential collider bias.

<br>

#  Description of Hypothetical Cohort Study 
This is a hypothetical cohort study of sex/gender differences in dementia incidence.  The hypothetical cohort included 100,000 men and women recruited at age 50 years and followed for dementia incidence until age 95 (45 years).  To quantify the extent to which selective survival could plausibly explain higher dementia incidence in men compared to women at older ages, we generated the data assuming no effect of sex/gender on late-life cognitive trajectories and dementia incidence. Thus, associations between sex/gender and dementia incidence reflect survival bias in our simulations.  

## Survival 

Sex-specific survival distributions from ages 50-95 years were generated to match survival distributions from European life tables. We found European cohort life tables on UC Berkeley's repository:  [https://www.mortality.org/](https://www.mortality.org/).  For those countries included in the EURODEM study, Figure 1.1 shows mortality hazard ratios plotted for the 1920-1925 birth cohort.  

**Figure 1.1:  Published mortality hazard ratios for countries in the EURODEM ttudy**

```{r HR Plots, fig.align="center"}
Hratio_Netherlands <- netherlands_F$Haz/netherlands_M$Haz %>%
  as.data.frame() %>% set_colnames("Netherlands") 
Hratio_Denmark <- denmark_F$Haz/denmark_M$Haz %>%
  as.data.frame() %>% set_colnames("Denmark") 
Hratio_France <- france_F$Haz/france_M$Haz %>%
  as.data.frame() %>% set_colnames("France") 

HR_plot_data <- 
  cbind(Hratio_Netherlands, Hratio_Denmark, Hratio_France) %>% 
  mutate("Age" = seq(50, 95, by = 5)) %>%
  gather(c("Netherlands", "Denmark", "France"), 
         key = "Country", value = "HR") %>% 
  mutate_at("Country", as.factor)
HR_plot_data$Country <- fct_relevel(HR_plot_data$Country, 
                                    "France", after = 2)

ggplot(HR_plot_data, aes(Age, HR)) + 
  geom_line(aes(color = Country, group = Country), size = 1.25, alpha = 0.6) +
  labs(y = "Mortality Hazard Ratio (Female:Male)", x = "Age", 
       color = "") + ylim(0, 1) + theme_minimal() + 
  scale_y_continuous(breaks = seq(0, 1, 0.2)) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("1920-1925 Birth Cohort")
```

Since the Netherlands cohort was the largest sample included in the EURODEM study and because their mortality hazard ratios provided a nice middle ground in the 50+ age group, we decided to use Netherlands life tables as our benchmark.  

Using R's optim function, we were able to solve for the $\lambda$ values (baseline hazard for women in each 5-year age band) in our survival model so that conditional probabilities of survival, i.e. survival to age X + 5, conditional on survival to age X, in our simulated data closely matched those calculated from the Netherlands life tables.  Table 1.1 shows the computed values of $\lambda$ and Figure 1.2 compares the published and simulated cumulative survival probabilities from age 50 years, i.e., conditional on survival to age 50, the probability of surviving to each age.  Figure 1.3 compares the published and simulated mortality hazard ratios from ages 50+.  Both the simulated survival probabilities and the modeled mortality hazard ratios were averaged over 100 iterations of sample generation.  The average of the mortality hazard ratios was computed by first taking the mean(ln(mortality HR)), then exponentiating.  Average cumulative incidence of mortality  = `r round((1 - sim_results$p_alive[length(sim_results$p_alive)])*100, 1)`% across the 100 runs.  

<br>

**Table 1.1:  Baseline hazard for females in each 5-year age band**

```{r Lambda values}
lambda_values <- lambda %>% t() %>% as.data.frame() %>%
  set_colnames(age_labels$formatted_age_intervals) %>% set_rownames("Lambda")

kable(lambda_values) 
```

<br>

**Figure 1.2: Average simulated cumulative survival probabilites from age 50 years across 100 simulation runs**

```{r Survival plot data}
all_cp_survival <- c(1, sim_results$p_alive)
female_cp_survival <- c(1, sim_results$p_alive_females)
male_cp_survival <- c(1, sim_results$p_alive_males)

#Netherlands data that we need
netherlands_MF_survival <- netherlands_MF %>% filter(Age >= 50)
netherlands_M_survival <- netherlands_M %>% filter(Age >= 50)
netherlands_F_survival <- netherlands_F %>% filter(Age >= 50)

#Calculating cumulative survival from age 50
netherlands_MF_survival$CP <- 
  netherlands_MF_survival$lx/netherlands_MF_survival$lx[1]
netherlands_M_survival$CP <- 
  netherlands_M_survival$lx/netherlands_M_survival$lx[1]
netherlands_F_survival$CP <- 
  netherlands_F_survival$lx/netherlands_F_survival$lx[1]

plot_data <- tibble("age" = seq(50, 95, by = 5), 
                      "pub_all_survival" = netherlands_MF_survival$CP, 
                      "pub_female_survival" = netherlands_F_survival$CP, 
                      "pub_male_survival" = netherlands_M_survival$CP, 
                      "cohort_all_survival" = all_cp_survival, 
                      "cohort_female_survival" = female_cp_survival, 
                      "cohort_male_survival" = male_cp_survival) 
```

```{r All survival plots, fig.align="center", out.width="60%"}
#All survival plot
plot_data_all <- plot_data %>% dplyr::select(age, contains("all")) %>%
  gather(key = key, value = value, 
         c("pub_all_survival", "cohort_all_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_all_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_all, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Whole Population", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal()
```

```{r Survival Plots by sex, fig.pos="hold", out.width="50%"}
#Female survival plot
plot_data_female <- plot_data %>% dplyr::select(age, contains("female")) %>%
  gather(key = key, value = value, 
         c("pub_female_survival", "cohort_female_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_female_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_female, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Females", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal()

#Male survival plot
plot_data_Male <- plot_data %>% dplyr::select(age, contains("Male")) %>%
  gather(key = key, value = value, 
         c("pub_male_survival", "cohort_male_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_male_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_Male, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Males", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal()
```

<br>

**Figure 1.3: Average simulated mortality hazard ratios for age 50+ across 100 simulation runs**  
Ages on the x-axis represent the age at the start of interval, i.e. 50 represents the mortality HR for the interval [50, 55).

```{r pub vs. sim HR, fig.align="center"}
published_HR <- head(netherlands_F$Haz/netherlands_M$Haz, -1) %>%
  as.data.frame() %>% set_colnames("Published Mortality HR")

simulated_HRs <- sim_results$`mortality_HRs(F:M)` %>%
  as.data.frame() %>% set_colnames("Modeled Mortality HR")

pub_sim_HR_data_cox <- 
  cbind(published_HR, simulated_HRs) %>% 
  mutate("Age" = seq(50, 90, by = 5)) %>%
  gather(c("Published Mortality HR", "Modeled Mortality HR"), 
         key = "Data Type", value = "HR") %>% 
  mutate_at("Data Type", as.factor)
pub_sim_HR_data_cox$`Data Type` <- fct_relevel(pub_sim_HR_data_cox$`Data Type`, 
                                               "Published Mortality HR", 
                                               after = 1)

ggplot(pub_sim_HR_data_cox, aes(Age, HR)) + 
  geom_line(aes(color = `Data Type`, group = `Data Type`), size = 1.25, 
            alpha = 0.6) +
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(y = "Mortality Hazard Ratio (Female:Memale)", x = "Age", 
       color = "") + theme_minimal() + 
  ggtitle("Mortality Hazard Ratios")
```
 
## Dementia

Dementia incidence was generated based on cognitive function using age-specific cut points for cognitive function below a "dementia" threshold.  Age-specific cut points for dementia were updated every five years such that lower cognitive function that would be considered consistent with dementia at younger ages could be considered "normal" at older ages.  The chosen dementia cut points and their associated percentiles are displayed in Table 1.2. There was no interval censoring included in our simulations; age at dementia diagnosis was based on the age at which a participant's cognitive function fell below the diagnostic threshold for the 5-year age band.  Age-specific dementia incidence rates for ages 65-95 were generated to match sex-pooled dementia incidence rates from the EURODEM study.  

**Table 1.2:  Dementia cut points and associated percentiles**  
The percentile is the proportion of susceptible that will be diagnosed with dementia

```{r cutoffs and percentiles}
Cij_data <- test_data %>% dplyr::select(variable_names$Cij_varnames)
means <- Cij_data %>% map_dbl(~ mean(., na.rm = TRUE))
SDs <- Cij_data %>% map_dbl(~ sd(., na.rm = TRUE))

percentile <- vector(length = length(dem_cuts))
for(i in 1:length(dem_cuts)){
  percentile[i] <- pnorm(dem_cuts[i], mean = means[i], sd = SDs[i])
}

percentile_table <- rbind(dem_cuts, percentile)
colnames(percentile_table) <- age_names$age_names
rownames(percentile_table) <- c("Dementia Cutoff", "Percentile")
kable(percentile_table)
```

<br>

Average dementia incidence rates per 1000 person years across 100 simulated cohorts are displayed in Table 1.3. The dementia incidence rates from the EURODEM study, used as reference, are displayed in the first line of the table. The average dementia hazard ratios across 100 simulated scenarios are displayed in Table 1.4, and the average incidence rate ratios are displayed in Table 1.5.  In both cases, ratios are presented as female:male.

<br>

**Table 1.3: Dementia incidence rates**  
Source: Gender differences in the incidence of AD and vascular dementia: 
The EURODEM Studies (Andersen 1999); Table 2

```{r dem_table}
dem_table <- 
  tibble("EURODEM" = c(" ", " ", " ", 
                       round(head(EURODEM_inc_rates$Total_All_Dementia_1000PY, 
                                  -1), 3)), 
         "Scenario A" = " ", 
         "F" = sim_results$sim_rates_females, 
         "M" = sim_results$sim_rates_males, 
         "Combined" = sim_results$sim_rates) %>% t() %>% 
  set_colnames(age_labels$formatted_age_intervals)

kable(dem_table)
```

<br>

**Table 1.4: Average hazard ratios for dementia (exponentiated mean(ln(dementia HR)) across 100 simulation runs)**  

```{r hr_table}
age_labels <- tibble("age" = c("age ", rep("", (num_tests - 1))), 
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", sep = "")

hr_table <- 
  tibble("Scenario A" = " ", 
         "HR" = sim_results$`dem_HRs(F:M)`) %>% t() %>% 
  set_colnames(age_labels$formatted_age_intervals)

kable(hr_table)
```

<br>

**Table 1.5: Average incidence rate ratios for dementia (exponentiated mean(ln(IRR)) across 100 simulation runs)**  

```{r IRR_table}
age_labels <- tibble("age" = c("age ", rep("", (num_tests - 1))), 
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", sep = "")

IRR_table <- 
  tibble("Scenario A" = " ", 
         "IRR" = sim_results$`IRRs(F:M)`) %>% t() %>% 
  set_colnames(age_labels$formatted_age_intervals)

kable(IRR_table)
```

<br>

# Some results from one simulated cohort

##  Cognitive Trajectories

**Figure 2.1:  Mean cognitive trajectories overlayed on a random sample of 10 individual's trajectories.**

```{r Cognitive trajectories, fig.align="center"}
Cij_check <- test_data %>% dplyr::select(sex, variable_names$Cij_varnames)

#Getting mean Cij by sex
female_meanCij<- Cij_check %>% filter(sex == 0) %>% colMeans(., na.rm = TRUE)
male_mean_Cij <- Cij_check %>% filter(sex == 1) %>% colMeans(., na.rm = TRUE)

#Checking the mean slopes by sex
slopes_check <- test_data %>% dplyr::select(sex, contains("slope"))
female_slopes_check <- slopes_check %>% filter(sex == 0) %>% colMeans()
male_slopes_check <- slopes_check %>% filter(sex == 1) %>% colMeans()

female_mean_plot <- tibble("Age" = seq(50, 95, by = 5), "variable" = "female", 
                           "value" = female_meanCij[-1])

male_mean_plot <- tibble("Age" = seq(50, 95, by = 5), "variable" = "male", 
                         "value" = male_mean_Cij[-1])


#Create all plot data (includes random sample of Cij)
samp_Cij <- sample_n(Cij_check, 10) %>% 
  dplyr::select(-sex) %>% t() %>%
  cbind(., "Age" = seq(50, 95, by = 5)) %>% as.data.frame() %>% 
  melt(., id.vars = "Age") %>% rbind(., female_mean_plot) %>% 
  rbind(., male_mean_plot)

#---- Plot a sample of Cij ----
#Creating a plot with random sample in the background
ggplot(samp_Cij, aes(Age, value)) + 
  geom_line(data = 
              subset(samp_Cij, variable != "female" & variable != "male"), 
            aes(group = variable), color = "gray") +
  geom_line(data = subset(samp_Cij, variable == "female"), 
            aes(color = variable), size = 1.25) + 
  geom_line(data = subset(samp_Cij, variable == "male"), 
            aes(color = variable), size = 1.25, alpha = 0.6) + 
  labs(y = "Cognitive Function", 
       x = "Age", 
       color = "Mean Cognitive \n Function") + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("Mean Cognitive Trajectories") +
  theme_minimal()
```

<br>

**Table 2.1: Mean slopes at each interval** 

```{r Slopes table}
slopes <- cumsum(cij_slopes)[-1] %>% as.data.frame() %>% t() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("")

kable(slopes)
```

<br>

**Table 2.2:  Variance of random slope for each interval**  

```{r slope variance table}
slope_var <- cij_var1[-1] %>% as.data.frame() %>% t() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("")

kable(slope_var)
```

## Dementia Cases

**Figure 2.2:  Dementia cases by age**  
Incident cases at each age are plotted in blue

```{r Dementia incidence rate plot, fig.align="center"}
cutoffs <- dem_cuts
Cij_data <- test_data %>% dplyr::select(variable_names$Cij_varnames)
dem_wave_data <- test_data %>% dplyr::select(dem_wave)
Cij_indicators <- matrix(0, nrow = nrow(Cij_data), ncol = ncol(Cij_data))
for(i in 1:nrow(dem_wave_data)){
  if(!is.na(dem_wave_data[i, ])){
    slot <- dem_wave_data[i, ]
    Cij_indicators[i, (slot + 1)] <- 1
  }
}
indicators <- unlist(as.data.frame(Cij_indicators))

#Colnames for hist data
age_names <- tibble("Age" = rep("Age", 10), 
                    "number" = seq(50, 95, by = 5)) %>%
  unite("age_names", sep = " ")

hists <- Cij_data %>% set_colnames(age_names$age_names) %>% gather() %>% 
  mutate_at("key", as.factor) 
hists$indicators <- indicators

z <- data.frame(key = levels(hists$key), 
                cutoff = cutoffs)
  
hists %>% ggplot(aes(value)) + 
  geom_vline(data = z, aes(xintercept = cutoff), color = "black", size = 1) + 
  geom_histogram(fill = "gray", alpha = 0.6) + 
  geom_histogram(data = hists %>% filter(indicators == 1), fill = "dodgerblue2", 
                 alpha = 0.6) + 
  labs(title = "Dementia Cases by Age", 
       x = "Cognitive Level", 
       y = "Live People") + 
  facet_wrap(~ key, scales = "free") + 
  xlim(-30, 3.5) + theme_minimal()
```

<br>

**Table 2.3:  Prevalence of dementia**  
Estimating this is not our primary goal, but we thought this might be another good sanity check.  We expect that these numbers are higher than what they should be because in this scenario, dementia does not kill anyone. 

```{r Dementia prevalance}
dem_prev <- test_data %>% dplyr::select(variable_names$dem_varnames) %>% 
  colMeans(na.rm = TRUE) %>% as.data.frame() %>% t() %>%
  set_colnames(age_names$age_names) %>% set_rownames("Prevalence")

kable(dem_prev)
```

## Distributions of U

**Figure 2.3:  Distribution of U**

```{r U dists, fig.align="center"}
dem_data <- test_data %>% 
  dplyr::select(c("sex", "U", "death0", 
                  head(variable_names$deathij_varnames, -1))) %>%
  mutate("Sex" = if_else(sex == 1, "Male", "Female")) %>% 
  dplyr::select(-one_of("sex")) %>% 
  dplyr::select("U", "death0", everything()) %>% 
  set_colnames(c("U", age_names$age_names, "Sex")) %>%
  gather(contains("Age"), 
         key = "Age", value = "death_indicator") %>%
  filter(death_indicator == 0)

dem_data %>% ggplot(aes(x = U)) + 
  geom_histogram(data = dem_data %>% filter(Sex == "Female"), 
                 aes(y = ..density.., fill = "Female"),
                 binwidth = 0.01) +
  geom_histogram(data = dem_data %>% filter(Sex == "Male"), 
                 aes(y = ..density.., fill = "Male"), alpha = 0.5,
                 binwidth = 0.01) + 
  xlim(-5, 5) + ylim(0, 0.6) + 
  labs(title = "Distribution of U by Age", 
       x = "U", 
       y = "Density") + 
  facet_wrap(~ Age, scales = "free") + theme_minimal() + 
  theme(legend.title = element_text("Sex"))
```

## Extra Sanity Check Calculations

**Table 2.4:  Dementia-free person-years contributed to each 5-year age interval by sex**

```{r PY by sex}
py_by_sex <- test_data %>% group_by(sex) %>% 
  dplyr::select(head(variable_names$contributed_varnames, -1)) %>% 
  summarise_all(~sum(., na.rm = TRUE)) %>% 
  mutate(Sex = case_when(sex == 0 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(-one_of("sex")) %>% 
  dplyr::select(Sex, everything()) %>% 
  set_colnames(c("Sex", age_labels$formatted_age_intervals))

kable(py_by_sex)
```

<br>

**Table 2.5:  Number of incident dementia cases by age and sex in each 5-year age interval**

```{r Dem inc}
dem_inc_by_sex <- test_data %>%
  dplyr::select(sex, dem_wave) %>% 
  mutate_at("dem_wave", as.factor) %>% 
  mutate(Sex = case_when(sex == 0 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(Sex, dem_wave) %>% 
  group_by(Sex) %>%
  count(dem_wave) %>% 
  filter(dem_wave != "NA") %>% spread(key = Sex, value = n) %>% t() %>%
  set_rownames(c("Sex", "Female", "Male")) %>% 
  set_colnames(age_labels$formatted_age_intervals)
  
kable(dem_inc_by_sex[-1, ])
```



