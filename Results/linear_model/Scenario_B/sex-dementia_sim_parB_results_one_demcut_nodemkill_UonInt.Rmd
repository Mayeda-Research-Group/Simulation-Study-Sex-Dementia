---
title: "Simulation Scenario B"
subtitle: "One dementia cut point; Effect of U on Cognitive Intercept"
output: 
  bookdown::html_document2:
    fig_caption: TRUE
    table_caption: TRUE
    theme: yeti
    toc: TRUE
    toc_float: 
      collapsed: FALSE
    toc_depth: 2
bibliography: sex-dementia_sim_bib.bib 
csl: ieee-with-url.csl
header-includes: 
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r Pacman statement}
if (!require("pacman")) 
  install.packages("pacman", repos='http://cran.us.r-project.org')

p_load("bookdown", "here", "tidyverse", "knitr", "kableExtra", "magrittr", 
       "reshape2", "survival")

options(digits = 3)
options(scipen = 999)
```

```{r Seed setting}
set.seed(03122019)
```

```{r Sourcing scripts}
source(here("RScripts", "dementia_incidence_EURODEM_pooled.R"))
source(here("RScripts", "life_table_calcs.R"))
source(
  here("RScripts", "linear_model",
       "sex-dementia_sim_parB_onedemcut_nodemkill_UonInt.R"))
source(here("RScripts", "linear_model", "variable_names.R"))
source(here("RScripts", "misc_custom_functions.R"))
```

```{r Loading data, eval = TRUE}
#Life table data
netherlands_MF <- read_csv(here("Data", "Netherlands_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
netherlands_M <- read_csv(here("Data", "Netherlands_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
netherlands_F <- read_csv(here("Data", "Netherlands_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_MF <- read_csv(here("Data", "denmark_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_M <- read_csv(here("Data", "denmark_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
denmark_F <- read_csv(here("Data", "denmark_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_MF <- read_csv(here("Data", "france_cohort_MF_calcs"), 
                           col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_M <- read_csv(here("Data", "france_cohort_M_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)
france_F <- read_csv(here("Data", "france_cohort_F_calcs"), 
                          col_names = TRUE) %>% 
  filter(Year == "1920-1925" & Age < 100 & Age >= 50)

#One simulation run
dataset <- 
  readRDS(here(
    "Data", "linear_model",
    "dataset_B_onedemcut_nodemkill_UonInt_500000_20190822")) %>% 
  as.data.frame()

#Data Analyses
sim_results <- 
  read_csv(
    here("Results", "linear_model", "Scenario_B", 
         "one_demcut_uniform_timetodem_nodemkill_UonInt_1000_20190918.csv")) %>% 
  na.omit()

mean_sim_results <- colMeans(sim_results)

sd_sim_results <- apply(sim_results, 2, sd)
```

```{r Column names}
#Interval labels i.e. [50, 55)
age_labels <- tibble("Age" = c("Age ", rep("", (num_tests - 1))), 
                     "Age_rep" = rep("Age ", num_tests),
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", 
        c("Age", "left_brack", "interval_ages", "right_pren"), sep = "", 
        remove = FALSE) %>%
  unite("Age_interval", 
        c("Age_rep", "left_brack", "interval_ages", "right_pren"), sep = "", 
        remove = FALSE)
```

<br>
<br>

```{r DAG, fig.align="center", out.width="75%"}
knitr::include_graphics(here("DAGs", "sex-dem_sim_parB_DAG.png"))
```
<br>

In this scenario, sex influences survival while U influences the rate of cognitive change and dementia incidence.  The dotted line from U to survival represents the fact that in this causal structure, U does not influence survival; but the effects of U on survival will be added in future scenarios consistent with collider bias.

<br>

#  Description of Hypothetical Cohort Study 
This is a hypothetical cohort study of sex/gender differences in dementia incidence.  The hypothetical cohort included 100,000 men and women recruited at age 50 years and followed for dementia incidence until age 95 (45 years).  To quantify the extent to which selective survival could plausibly explain higher dementia incidence in women compared to men at older ages, we generated the data assuming no effect of sex/gender on late-life cognitive trajectories and dementia incidence. Thus, associations between sex/gender and dementia incidence reflect survival bias in our simulations.  

## Survival 
Andersen, et al. (1999) [@Andersen1999] include data from Denmark, France, the Netherlands, and the UK in their pooled EURODEM analysis.  For those countries with cohort life tables available on UC Berkeley's repository (all but the UK), Figure \@ref(fig:HR-Plots) shows mortality hazard ratios plotted for the 1920-1925 birth cohort.  The respository for these life tables can be found here:  [https://www.mortality.org/](https://www.mortality.org/).  

Since the Netherlands cohort was the largest sample included in the pooled EURODEM analysis and because their mortality hazard ratios provided a nice middle ground in the 50+ age group (seen in Figure \@ref(fig:HR-Plots)), we decided to use Netherlands cohort life tables as our benchmark.  

```{r HR-Plots, fig.align = "center", out.width = "75%", fig.cap = "Female:Male mortality hazard ratios calculated from life tables for Denmark, the Netherlands, and France (three of the primary countries included in the Eurodem study)."}
Hratio_Netherlands <- netherlands_F$Haz/netherlands_M$Haz %>%
  as.data.frame() %>% set_colnames("Netherlands") 
Hratio_Denmark <- denmark_F$Haz/denmark_M$Haz %>%
  as.data.frame() %>% set_colnames("Denmark") 
Hratio_France <- france_F$Haz/france_M$Haz %>%
  as.data.frame() %>% set_colnames("France") 

HR_plot_data <- 
  cbind(Hratio_Netherlands, Hratio_Denmark, Hratio_France) %>% 
  mutate("Age" = seq(50, 95, by = 5)) %>%
  gather(c("Netherlands", "Denmark", "France"), 
         key = "Country", value = "HR") %>% 
  mutate_at("Country", as.factor)
HR_plot_data$Country <- fct_relevel(HR_plot_data$Country, 
                                    "France", after = 2)

ggplot(HR_plot_data, aes(Age, HR)) + 
  geom_line(aes(color = Country, group = Country), size = 1.25, alpha = 0.6) +
  labs(y = "Mortality Hazard Ratio (Female:Male)", x = "Age", 
       color = "") + ylim(0, 1) + theme_minimal() + 
  scale_y_continuous(breaks = seq(0, 1, 0.2)) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("1920-1925 Birth Cohort")
```

Sex-specific survival distributions from ages 50-95 years were generated to match survival distributions from the Netherlands cohort life table (1920-1925 birth cohort.)  For individual $i$ in time interval $j$, time to death was generated as a random variable drawn from an exponential survival distribution based on the hazard function in Equation \@ref(eq:mort-hazard). 

\begin{equation}
h_{\text{death}_{ij}}(t) =  \lambda_{j}\exp\{\gamma_{1j}\text{sex}_i + \gamma_2U_i + \gamma_3\text{slope}_{ij} + \gamma_4\text{C}_{ij}\},
(\#eq:mort-hazard)
\end{equation}

where $U_i \sim N(0, 1)$.  The values for each of the coefficients in the hazard function are displayed in Table \@ref(tab:mort-haz-coeff).  In the table, $\gamma_{10}-\gamma_{19}$ represent the age-specific effect of sex/gender on mortality.  Note that $\gamma_2-\gamma_4$ are set to 0 in Simulation Scenario A signifying that in this scenario, there is no effect of U on mortality and no effects of cognitive slope or cognitive level on mortality.

```{r mort-haz-coeff}
coeff_table <- 
  tibble("Simulation Scenario" = rep("", 22), 
         "A" = c(g1, g2, g3, g4, g5, g6[-1])) %>% 
  t() %>% 
  set_colnames(c("$\\gamma_{11}$", "$\\gamma_{12}$", 
                 "$\\gamma_{13}$", "$\\gamma_{14}$", "$\\gamma_{15}$", 
                 "$\\gamma_{16}$", "$\\gamma_{17}$", "$\\gamma_{18}$",
                 "$\\gamma_{19}$", "$\\gamma_{2}$", "$\\gamma_{3}$", 
                 "$\\gamma_{4}$", "$\\gamma_{5}$", "$\\gamma_{61}$", 
                 "$\\gamma_{62}$", 
                 "$\\gamma_{63}$", "$\\gamma_{64}$", "$\\gamma_{65}$", 
                 "$\\gamma_{66}$", "$\\gamma_{67}$", "$\\gamma_{68}$",
                 "$\\gamma_{69}$"))

kable(coeff_table, escape = FALSE, 
      caption = "Coefficients used to generate mortality hazard") %>% 
  kable_styling()
```

Using R's optim function [@Roptim], we solved for the $\lambda_j$ values (baseline mortality hazard for women in each 5-year age band) in our hazard function so that conditional probabilities of survival, i.e. survival to age X + 5, conditional on survival to age X, in our simulated data closely matched those calculated from the Netherlands cohort life tables.  Note that although all of our analyses are presented with males as the reference group, females were used as the reference group throughout the data-generation process.

Table \@ref(tab:Lambda-values) shows the computed values of $\lambda_j$ for our hazard function. Figure \@ref(fig:survival-plots) compares the simulated cumulative survival probabilities from age 50 years based on these $\lambda_j$, i.e., the probability of surviving to each age conditional on survival to age 50, with cumulative survival probabilites calculated from the Netherlands life tables.  Figure \@ref(fig:mort-HR-plots) compares the simulated mortality hazard ratios from ages 50+ to those calculated from life tables.  Both the survival probabilities calculated from simulated data and the modeled mortality hazard ratios were averaged over `r runs` iterations of sample generation.  The average of the mortality hazard ratios was computed by first taking the mean of the observed age-specific ln(mortality HR) across the `r runs` simulated samples and then exponentiating.  Average cumulative mortality  = `r as.numeric(round((1 - mean_sim_results["p_alive_95"])*100, 1))`% across the `r runs` simulated samples.

<br>

```{r Lambda-values}
lambda_values <- lambda %>% t() %>% as.data.frame() %>%
  set_colnames(age_labels$formatted_age_intervals) %>% set_rownames("Lambda")

kable(lambda_values, 
      caption = "Baseline hazard for females in each 5-year age band") %>% kable_styling()
```

<br>

```{r Survival plot data}
all_cp_survival <- 
  c(1, mean_sim_results[na.omit(variable_names$p_alive_varnames)])
female_cp_survival <- 
  c(1, mean_sim_results[na.omit(variable_names$p_alive_females_varnames)])
male_cp_survival <- 
  c(1, mean_sim_results[na.omit(variable_names$p_alive_males_varnames)])

#Netherlands data that we need
netherlands_MF_survival <- netherlands_MF %>% filter(Age >= 50)
netherlands_M_survival <- netherlands_M %>% filter(Age >= 50)
netherlands_F_survival <- netherlands_F %>% filter(Age >= 50)

#Calculating cumulative survival from age 50
netherlands_MF_survival$CP <- 
  netherlands_MF_survival$lx/netherlands_MF_survival$lx[1]
netherlands_M_survival$CP <- 
  netherlands_M_survival$lx/netherlands_M_survival$lx[1]
netherlands_F_survival$CP <- 
  netherlands_F_survival$lx/netherlands_F_survival$lx[1]

plot_data <- tibble("age" = seq(50, 95, by = 5), 
                      "pub_all_survival" = netherlands_MF_survival$CP, 
                      "pub_female_survival" = netherlands_F_survival$CP, 
                      "pub_male_survival" = netherlands_M_survival$CP, 
                      "cohort_all_survival" = all_cp_survival, 
                      "cohort_female_survival" = female_cp_survival, 
                      "cohort_male_survival" = male_cp_survival) 
```

```{r survival-plots, fig.show="hold", out.width="50%", fig.cap=paste("Average simulated cumulative survival probabilites from age 50 years across", runs, "iterations of sample generation")}
#Female survival plot
plot_data_female <- plot_data %>% dplyr::select(age, contains("female")) %>%
  gather(key = key, value = value, 
         c("pub_female_survival", "cohort_female_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_female_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_female, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Females", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))

#Male survival plot
plot_data_Male <- plot_data %>% dplyr::select(age, contains("Male")) %>%
  gather(key = key, value = value, 
         c("pub_male_survival", "cohort_male_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_male_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_Male, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Males", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))

#All survival plot
plot_data_all <- plot_data %>% dplyr::select(age, contains("all")) %>%
  gather(key = key, value = value, 
         c("pub_all_survival", "cohort_all_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_all_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_all, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Whole Population", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal()
```

<br>

```{r mort-HR-plots, fig.align="center", out.width = "75%", fig.cap=paste("Average simulated mortality hazard ratios for age 50+ across", runs, "simulation runs. Ages on the x-axis represent the age at the start of interval, i.e. 50 represents the mortality HR for the interval [50, 55).")}
source(here("RScripts", "life_table_calcs.R"))
published_HR <- Hratio_Netherlands[12:20, ] %>%
  as.data.frame() %>% set_colnames("Published Mortality HR")

simulated_HRs <- 
  exp(mean_sim_results[na.omit(variable_names$mortality_logHR_varnames)]) %>%
  as.data.frame() %>% set_colnames("Modeled Mortality HR")

pub_sim_HR_data_cox <- 
  cbind(published_HR, simulated_HRs) %>% 
  mutate("Age" = seq(50, 90, by = 5)) %>%
  gather(c("Published Mortality HR", "Modeled Mortality HR"), 
         key = "Data Type", value = "HR") %>% 
  mutate_at("Data Type", as.factor)
pub_sim_HR_data_cox$`Data Type` <- fct_relevel(pub_sim_HR_data_cox$`Data Type`,
                                               "Modeled Mortality HR",
                                               after = 1)

ggplot(pub_sim_HR_data_cox, aes(Age, HR)) + 
  geom_point(aes(color = `Data Type`, group = `Data Type`), size = 1.75) + 
  geom_line(aes(color = `Data Type`, group = `Data Type`), size = 1.25, 
            alpha = 0.6) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(y = "Mortality Hazard Ratio (Female:Memale)", x = "Age", 
       color = "") + theme_minimal() + 
  #theme(text = element_text(size = 40)) + 
  ggtitle("Mortality Hazard Ratios")
```
 
## Dementia

Dementia incidence was generated based on cognitive function using age-specific cut points for cognitive function below an age-specific cut point for "dementia". For each individual $i$ at the start of time interval $j$, we generate a value of cognitive function $Cij$ following an autoregressive (AR(1)) linear model with a random intercept ($\zeta_{0i}$) and random slope ($\zeta_{1i}$) drawn from a bivariate normal distribution with mean 0, variances $\sigma^2_{\zeta_0}$ and $\sigma^2_{\zeta_{1j}}$, and covariance $\sigma_{\zeta_{01}}$.  Note that while the variance of the random intercept and its covariance with the random slope stay constant over time, the variance of the random slope terms is time-dependent.  Specifically, we allow the variance of the random slope to increase with age.  The model for generating $C_{ij}$ is displayed in \@ref(eq:Cij)

\begin{equation}
C_{ij}(t) = \beta_{00} + \zeta_{0i} + \beta_{01}\text{sex}_i + \beta_{02}\text{age0_c50}_{i} + \beta_{03}U_i + \varepsilon_{ij} + (\text{slope}_{ij} + \zeta_{1i} + \beta_{11}\text{sex}_i + \beta_{12}\text{age0_c50} + \beta_{13}U_i)t,
(\#eq:Cij)
\end{equation}

where $\text{age0_c50}_i$ is person $i$'s baseline age centered at age 50 (0 for everyone since everyone is age 50 at the start of this hypothetical study) and where $U_i \sim N(0,1)$. Here, $\varepsilon_{ij}$ represents unexplained variation in $C_{ij}$ where $\varepsilon_{ij} \sim N(0, \sigma^2_{\varepsilon})$ and $\text{cov}(\varepsilon_{i, j}, \varepsilon_{i, k}) = \rho_{\varepsilon}^{|j - h|}\sigma^2_{\varepsilon_{ij}}$, where $j$ and $k$ represent time intervals.  This structure creates a within-person autoregressive model where the variance of $\varepsilon_{ij}$ is constant across waves.  

If an individual's value of cognitive function fell below the age bin-specific dementia cut point, we solved Equation \@ref(eq:dem-onset) for $t$ to get their time to dementia within that age bin.  The age at which an individual is diagnosed with dementia is calculated as their age at the start of the interval plus their time to dementia within that interval.

\begin{equation}
C_{ij} = \text{slope}_{ij}t + C_{i,j-1}
(\#eq:dem-onset)
\end{equation}

Age-specific cut points for dementia were updated every five years such that levels of cognitive function that would be classified as consistent with dementia at younger ages could be considered "normal" at older ages. Thus, the cognitive function cut points for dementia shifted to the left (to lower/more negative values of cognitive function) across age bins.  The chosen dementia cut points and their associated percentiles are displayed in Table \@ref(tab:dem-cuts).  Percentile values represent the proportion of the living, dementia-free cohort that will be diagnosed with dementia by the end of the time interval. There was no interval censoring included in our simulations; age at dementia diagnosis was based on the age at which a participant's cognitive function fell below the diagnostic threshold for the 5-year age band.  Age-specific dementia incidence rates for ages 65-95 were generated to match sex-pooled dementia incidence rates from the EURODEM study.  The data were generated assuming no effect of sex/gender on late-life cognitive trajectories and dementia incidence, thus associations between sex/gender and dementia incidence reflect survival bias in our simulations.   


```{r dem-cuts}
cutoffs <- rep(dem_cut, 10)
Cij_data <- dataset %>% dplyr::select(variable_names$Cij_varnames)
means <- Cij_data %>% map_dbl(~ mean(., na.rm = TRUE))
SDs <- Cij_data %>% map_dbl(~ sd(., na.rm = TRUE))

percentile <- vector(length = 10)
for(i in 1:length(cutoffs)){
  percentile[i] <- pnorm(cutoffs[i], mean = means[i], sd = SDs[i])
}

percentile_table <- rbind(cutoffs, percentile)
colnames(percentile_table) <- c("Age <50", "[50, 55)",  age_labels$formatted_age_intervals[-1])
rownames(percentile_table) <- c("Dementia Cutoff", "Percentile")
kable(percentile_table, 
      caption = "Dementia cut points and associated percentiles. 
      The percentile is the proportion of susceptible that will be diagnosed 
      with dementia.") %>% 
  kable_styling()
```

<br>

Average dementia incidence rates per 1000 person years across `r runs` simulated samples are displayed in Table \@ref(tab:dem-inc-rates). The dementia incidence rates from the EURODEM study, used as reference, are displayed in the first line of the table. The average dementia hazard ratios across `r runs` simulated scenarios are displayed in Table \@ref(tab:hr-table), and the average incidence rate ratios are displayed in Table \@ref(tab:IRR-table).  In both cases, ratios are presented as female:male.

<br>

```{r dem-inc-rates}
dem_table <- 
  tibble("EURODEM F" = c(" ", " ", " ", 
                       round(head(EURODEM_inc_rates$Female_All_Dementia_1000PY, 
                                  -1), 3)), 
         "EURODEM M" = c(" ", " ", " ", 
                       round(head(EURODEM_inc_rates$Male_All_Dementia_1000PY, 
                                  -1), 3)), 
         "EURODEM Combined" = c(" ", " ", " ", 
                       round(head(EURODEM_inc_rates$Total_All_Dementia_1000PY, 
                                  -1), 3)), 
         "Simulation Scenario B" = " ", 
         "F" = as.vector(
           mean_sim_results[
             na.omit(variable_names$dem_inc_rate_females_varnames)]), 
         "M" = as.vector(
           mean_sim_results[
             na.omit(variable_names$dem_inc_rate_males_varnames)]),
         "Combined" = 
           as.vector(
             mean_sim_results[
               na.omit(variable_names$dem_inc_rate_varnames)])) %>% 
           t() %>% set_colnames(age_labels$formatted_age_intervals)

kable(dem_table, caption = 
"Dementia incidence rates. Source: Gender differences in the incidence of AD 
and vascular dementia: The EURODEM Studies (Andersen 1999); Table 2.") %>% kable_styling()
```

<br>

```{r hr-table}
hr_table <- 
  tibble("Simulation Scenario A" = " ", 
         "HR" = exp(
           mean_sim_results[
             na.omit(variable_names$dementia_logHR_varnames)])) %>% 
  t() %>% set_colnames(age_labels$formatted_age_intervals)

kable(hr_table, caption = 
        paste("Average hazard ratios for dementia 
              (exponentiated mean of the observed ln(dementia HR) across", runs, 
              "simulated samples).")) %>% 
  kable_styling()
```

<br>

```{r IRR-table}
IRR_table <- 
  tibble("Simulation Scenario A" = " ", 
         "IRR" = exp(
           mean_sim_results[na.omit(variable_names$logIRR_varnames)])) %>% 
  t() %>% set_colnames(age_labels$formatted_age_intervals)

kable(IRR_table, caption = paste("Average incidence rate ratios for dementia (exponentiated mean of the observed ln(dementia IRR) across", runs, "simulated samples).")) %>% kable_styling()
```

<br>

# Some results from one simulated sample

##  Cognitive Trajectories

```{r cog-trajectories, fig.align="center", fig.cap="Mean cognitive trajectories overlayed on a random sample of 10 individual's trajectories."}
Cij_check <- dataset %>% 
  dplyr::select("female", variable_names$Cij_varnames)

#Getting mean Cij by sex
female_meanCij<- Cij_check %>% filter(female == 1) %>% colMeans(., na.rm = TRUE)
male_mean_Cij <- Cij_check %>% filter(female == 0) %>% colMeans(., na.rm = TRUE)

#Checking the mean slopes by sex
slopes_check <- dataset %>% dplyr::select(female, contains("slope"))
female_slopes_check <- slopes_check %>% filter(female == 1) %>% colMeans()
male_slopes_check <- slopes_check %>% filter(female == 0) %>% colMeans()

female_mean_plot <- tibble("Age" = c(seq(50, 95, by = 5)), 
                           "variable" = "Women", 
                           "value" = female_meanCij[-1])

male_mean_plot <- tibble("Age" = seq(50, 95, by = 5), 
                         "variable" = "Men", 
                         "value" = male_mean_Cij[-1])

Cij_plot_data <- dataset %>% 
  dplyr::select("id", "female", variable_names$Cij_varnames, "survtime", 
                "last_Cij") %>% sample_n(50) %>% 
  mutate("Age" = survtime + 50) %>% 
  dplyr::select(-c(survtime, female)) %>% 
  set_colnames(c("id", variable_names$Cij_varnames, "Cij", "Age")) 


#Plot data
samp_Cij <- Cij_plot_data[, c("id", variable_names$Cij_varnames)] %>%
  set_colnames(c("id", seq(50, 95, by = 5))) %>% 
  gather(as.character(seq(50, 95, by = 5)), key = "Age", value = "Cij") %>% 
  mutate_at("Age", as.numeric) %>% 
  rbind(., Cij_plot_data[, c("id", "Age", "Cij")]) %>% 
  set_colnames(c("variable", "Age", "value")) %>% 
  rbind(., female_mean_plot) %>% 
  rbind(., male_mean_plot)

#---- Plot a sample of Cij ----
#Creating a plot with random sample in the background
ggplot(samp_Cij, aes(Age, value)) + 
  geom_line(data = 
              subset(samp_Cij, variable != "Women" & variable != "Men"), 
            aes(group = variable), color = "gray") +
  geom_line(data = subset(samp_Cij, variable == "Women"), 
            aes(color = variable), size = 1.25) + 
  geom_line(data = subset(samp_Cij, variable == "Men"), 
            aes(color = variable), size = 1.25, alpha = 0.6) + 
  geom_hline(yintercept = dem_cut, size = 1.25) + 
  labs(y = "Cognitive Function", 
       x = "Age", 
       color = "Mean Cognitive \n Function") + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("Mean Cognitive Trajectories") +
  theme_minimal() +  
  #theme(text = element_text(size = 28)) + 
  #coord_cartesian(ylim = c(-10, 10)) + 
  guides(color = guide_legend(reverse = TRUE))
```

<br>
**These values will eventually just be tables in the parameters for the $C_{ij}$ model.**

```{r mean-slopes}
Cij_check <- dataset %>% group_by(female) %>% 
  dplyr::select(c("female", variable_names$Cij_varnames)) %>% 
  summarise_all(mean, na.rm = TRUE)

slopes_check <- matrix(nrow = 2, ncol = (length(visit_times)))
colnames(slopes_check) = c("female", variable_names$interval_ages[1:9])
slopes_check[, "female"] = Cij_check$female

for(i in 2:ncol(slopes_check)){
  slopes_check[, i] <- as.matrix((Cij_check[, i + 1] - Cij_check[, i])/int_time)
}

kable(slopes_check, caption = "Observed mean slopes at each interval.  
      Note that the mean slope (rate of cognitive change) 
      becomes more negative with age.") %>% kable_styling()
```

<br>

```{r slope-var}
slope_var <- cij_var1[-1] %>% as.data.frame() %>% t() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("")

kable(slope_var, 
      caption = "Variance of random slope for each interval (input parameters). 
      Note that the variance of the random slope increases with age.") %>% kable_styling()
```

## Dementia Cases

```{r dem-cases-plot, fig.align="center", fig.cap="Dementia cases by age from one simulated sample. Incident cases at each age are plotted in blue. (Note that the y-axis differs across age bands because of the large difference in number of live people across age bins.)"}
cutoffs <- rep(dem_cut, 10)
Cij_data <- dataset %>% dplyr::select(variable_names$Cij_varnames)
dem_wave_data <- dataset %>% dplyr::select(dem_wave)
Cij_indicators <- matrix(0, nrow = nrow(Cij_data), ncol = ncol(Cij_data))
for(i in 1:nrow(dem_wave_data)){
  if(!is.na(dem_wave_data[i, ])){
    slot <- dem_wave_data[i, ]
    Cij_indicators[i, (slot + 1)] <- 1
  }
}
indicators <- unlist(as.data.frame(Cij_indicators))

hists <- Cij_data %>% 
  set_colnames(c("Age 50", age_labels$Age_interval)) %>% 
  gather() %>% 
  mutate_at("key", as.factor) 
hists$indicators <- indicators
hists$key <- fct_relevel(hists$key, "Age 50")

z <- data.frame(key = levels(hists$key), 
                cutoff = cutoffs)
  
hists %>% ggplot(aes(value)) + 
  geom_vline(data = z, aes(xintercept = cutoff), color = "black", size = 1) + 
  geom_histogram(fill = "gray", alpha = 0.6) + 
  geom_histogram(data = hists %>% filter(indicators == 1), fill = "dodgerblue2", 
                 alpha = 0.6) + 
  labs(title = "Dementia Cases by Age Interval", 
       x = "Cognitive Level", 
       y = "Live People") + 
  facet_wrap(~ key, scales = "free") + 
  xlim(-30, 3.5) + theme_minimal() 
#+ theme(text = element_text(size = 20))
```

<br>

```{r dem-prev}
dem_prev <- dataset %>% dplyr::select(variable_names$dem_varnames) %>% 
  colMeans(na.rm = TRUE) %>% as.data.frame() %>% t() %>%
  set_colnames(c("Age 50", "[50-55)", 
                 age_labels$formatted_age_intervals[-1])) %>% 
  set_rownames("Prevalence")

kable(dem_prev, 
      caption = "Prevalence of dementia by age for one simulated sample. 
      Estimating this is not our primary goal, but we thought this might be 
      another good sanity check.  We expect that these numbers are higher than 
      what they should be because in this scenario, 
      dementia does not kill anyone. ") %>% kable_styling()
```

## Distributions of U

```{r U-dists, fig.align="center", fig.cap="Distribution of U by age and sex/gender in one simulated sample."}
mean_U <- rep(0, 10)

dem_data <- dataset %>% 
  dplyr::select(c("female", "U", "death0", 
                  head(variable_names$deathij_varnames, -1))) %>%
  mutate("Sex" = if_else(female == 0, "Men", "Women")) %>% 
  dplyr::select(-one_of("female")) %>% 
  dplyr::select("U", "death0", everything()) %>% 
  set_colnames(c("U", "Age 50", age_labels$Age_interval, 
                 "Sex/Gender")) %>%
  gather(contains("Age"), 
         key = "Age", value = "death_indicator") %>%
  filter(death_indicator == 0) %>% 
  mutate_at("Sex/Gender", as.factor)

dem_data$Age <- fct_relevel(dem_data$Age, "Age 50")
dem_data$`Sex/Gender` <- fct_relevel(dem_data$`Sex/Gender`, "Men")

y <- data.frame(key = levels(dem_data$Age), cutoff = mean_U)
  
dem_data %>% ggplot(aes(x = U)) + 
  geom_vline(data = y, aes(xintercept = 0), color = "black", size = 1) + 
  geom_histogram(data = dem_data %>% filter(`Sex/Gender` == "Women"), 
                 aes(y = ..density.., fill = "Women"),
                 binwidth = 0.01) +
  geom_histogram(data = dem_data %>% filter(`Sex/Gender` == "Men"), 
                 aes(y = ..density.., fill = "Men"), alpha = 0.5,
                 binwidth = 0.01) + 
  xlim(-3, 3) + ylim(0, 0.6) + 
  labs(x = "U", 
       y = "Density") + 
  facet_wrap(~ Age, scales = "free") + theme_minimal() + 
  theme(legend.title = element_text("Sex/Gender")) +  
  theme(text = element_text(size = 20)) + 
  guides(fill = guide_legend(reverse = TRUE))

#numerical summaries of U
mean_U_summary <- dem_data %>% group_by(`Sex/Gender`, Age) %>% 
  summarise_at("U", mean)

#plot of numerical summary
mean_U_summary$Age <- rep(seq(50, 95, by = 5), 2)
ggplot(aes(Age, U), data = mean_U_summary) + 
  geom_point(aes(colour = `Sex/Gender`)) + theme_minimal() + 
  geom_line(aes(color = `Sex/Gender`)) + 
  ylab("Mean U") +  
  theme(text = element_text(size = 20))
```

## Extra Sanity Check Calculations

```{r PY-by-sex}
py_by_sex <- dataset %>% group_by(female) %>% 
  dplyr::select(head(variable_names$contributed_varnames, -1)) %>% 
  summarise_all(~sum(., na.rm = TRUE)) %>% 
  mutate(Sex = case_when(female == 1 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(-one_of("female")) %>% 
  dplyr::select(Sex, everything()) %>% 
  set_colnames(c("Sex", age_labels$formatted_age_intervals))

kable(py_by_sex, caption = "Dementia-free person-years contributed to each 
      5-year age interval by sex from one simulated sample.") %>% 
  kable_styling()
```

<br>

```{r Dem-inc 5-year}
dem_inc_by_sex <- dataset %>%
  dplyr::select(female, dem_wave) %>% 
  mutate_at("dem_wave", as.factor) %>% 
  mutate(Sex = case_when(female == 1 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(Sex, dem_wave) %>% 
  group_by(Sex) %>%
  count(dem_wave) %>% 
  filter(dem_wave != "NA") %>% spread(key = Sex, value = n) %>% t() %>%
  set_rownames(c("Sex", "Female", "Male")) %>% 
  set_colnames(age_labels$formatted_age_intervals)
  
kable(dem_inc_by_sex[-1, ], caption =  "Number of incident dementia cases in 
      each 5-year age interval by sex in one simulated sample.") %>% 
  kable_styling()
```

```{r Dem-inc 1-year}
mean_results <- 
  mean_sim_results[variable_names_1year$inc_cases_males_varnames] %>% 
  as.data.frame() %>% cbind(seq(51, 95, by = 1)) %>%
  set_colnames(c("inc_cases", "age"))

ggplot(aes(age, inc_cases), data = mean_results) + 
  geom_point(color = "#00BFC4", size = 2) + theme_minimal() + 
  xlab("Age") + ylab("Incident Dementia Cases") + 
  ggtitle("Incident Dementia Cases by Age") + 
  scale_x_continuous(breaks = seq(50, 95, by = 5))
```

```{r Dem-inc rate 1-year}
mean_inc_rate <- 
  mean_sim_results[variable_names_1year$inc_cases_males_varnames]/
  mean_sim_results[variable_names_1year$PY_males_varnames] %>% 
  as.data.frame() 

mean_inc_rate %<>% cbind(., seq(51, 95, by = 1)) %>% 
  set_colnames(c("inc_rate", "age"))


ggplot(aes(age, inc_rate), data = mean_inc_rate) + 
  geom_point(color = "#00BFC4", size = 4) + theme_minimal() + 
  xlab("Age") + ylab("Dementia Incidence Rate") + 
  ggtitle("Annual Dementia Incidence Rates") + 
  scale_x_continuous(breaks = seq(50, 95, by = 5)) 
#+ theme(text = element_text(size = 28))
```

```{r Dem-inc rate 1-year by sex}
mean_inc_rate_males <- 
  mean_sim_results[variable_names_1year$inc_cases_males_varnames]/
  mean_sim_results[variable_names_1year$PY_males_varnames] %>% 
  as.data.frame() %>% set_colnames(c("Male"))

mean_inc_rate_females <- 
  mean_sim_results[variable_names_1year$inc_cases_females_varnames]/
  mean_sim_results[variable_names_1year$PY_females_varnames] %>% 
  as.data.frame() %>% set_colnames(c("Female"))

mean_inc_rate_by_sex <- cbind(mean_inc_rate_females, mean_inc_rate_males)
mean_inc_rate_by_sex %<>% cbind(., seq(51, 95, by = 1)) %>% 
  set_colnames(c("female", "male", "age")) %>% 
  gather(c("female", "male"), key = "Sex", value = "inc_rate")


ggplot(aes(age, inc_rate), data = mean_inc_rate_by_sex) + 
  geom_point(aes(color = Sex), size = 4) + theme_minimal() + 
  xlab("Age") + ylab("Dementia Incidence Rate") + 
  ggtitle("Annual Dementia Incidence Rates") + 
  scale_x_continuous(breaks = seq(50, 95, by = 5)) 
#+ theme(text = element_text(size = 28))
```

# References






